#!/bin/sh -e

# Generate sources.lists on "setup-start" for "mini-buildd" chroots.

if [ "${1}" = "setup-start" ] && echo "${CHROOT_DESCRIPTION}" | grep --ignore-case --quiet "mini-buildd"; then
	# Bootstrap mbd lib and value support
	. /usr/share/mini-buildd/mbd-common.sh
	. /home/mini-buildd/.mini-buildd.conf

	[ "${AUTH_VERBOSITY}" == "quiet" ] || ${MBD_LOG} -s "I: Entering chroot: ${CHROOT_NAME}."
	# Compute BASEDIST, ARCH, and IS_EXPERIMENTAL
	# CHROOT_NAME=mbd-etch-ID-ARCH-*
	# CHROOT_NAME=mbd-etch-ID-experimental-ARCH-*
	BASEDIST=$(echo "${CHROOT_NAME}" | cut -d- -f2)
	ARCH=$(echo "${CHROOT_NAME}" | cut -d- -f4)
	IS_EXPERIMENTAL="false"
	if [ "${ARCH}" = "experimental" ]; then
		IS_EXPERIMENTAL="true"
		ARCH=$(echo "${CHROOT_NAME}" | cut -d- -f5)
	fi

	# Compute what KINDS of sources we have to add
	# We always want the basis distribution
	KINDS="base"
	if [ "${CHROOT_TYPE}" = "lvm-snapshot" -a "${AUTH_USER}" = "mini-buildd" ]; then
		# sbuild run using snapshot: Add extra (if configured), and ourselves (mbd).
		KINDS="${KINDS} extra mbd"
		if ${IS_EXPERIMENTAL}; then
			# Add our experimental dist (mbd_experimental)
			KINDS="${KINDS} mbd_experimental"
		fi
	fi

	# Finally generate sources list and preferences
	mbdGenSources "${BASEDIST}" "${KINDS}" "${ARCH}" >"${CHROOT_PATH}/etc/apt/sources.list"
	mbdGenPreferences "${BASEDIST}" "${KINDS}" "${ARCH}" "noheader" >"${CHROOT_PATH}/etc/apt/preferences"
fi
