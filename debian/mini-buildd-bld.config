#!/bin/bash -e

# @hack: Must be the same as in mbd-common.sh (we cannot include that so that pre-configuration is possible).
MBD_BLDCONFIGFILE="/home/mini-buildd/.mini-buildd-bld.conf"
MBD_BLDCONFIGVARS="mbd_rephttphost mbd_bldhost mbd_lvm_vg"

. /usr/share/debconf/confmodule

# Load config file, if it exists.
if [ -e "${MBD_BLDCONFIGFILE}" ]; then
	. "${MBD_BLDCONFIGFILE}" || true

	# Store values from config back to debconf
	for v in ${MBD_BLDCONFIGVARS}; do
		db_set mini-buildd-bld/${v} "${!v}"
	done
else
	# On-The-Fly default
	db_set mini-buildd-bld/mbd_rephttphost "$(hostname -f)"
fi

# First, get the repository's host name, and suck our configuration
REPO_FOUND=false
ERROR=""
TMP_REPCONFIGFILE=$(mktemp -t)
trap "rm -f ${TMP_REPCONFIGFILE}" EXIT

while ! ${REPO_FOUND}; do
	db_subst mini-buildd-bld/mbd_rephttphost ERROR "${ERROR}"
	db_input high mini-buildd-bld/mbd_rephttphost || true
	db_go || true
	db_get mini-buildd-bld/mbd_rephttphost || true
	mbd_rephttphost="${RET}"

	CONFIG_URL="http://${mbd_rephttphost}/~mini-buildd/config"
	if wget --quiet --output-document=- "${CONFIG_URL}" >"${TMP_REPCONFIGFILE}"; then
		REPO_FOUND=true
	else
		ERROR="ERROR: Repo config URL ${CONFIG_URL} fails: Please check mini-buildd-rep installation on ${mbd_rephttphost}."
	fi
done

. "${TMP_REPCONFIGFILE}"

BLDHOSTS=""
MBD_TMP_SEP=""
for arch in $(echo "${mbd_archs}" | tr -d ","); do
	host="mbd_bldhost_${arch}"
	BLDHOSTS="${BLDHOSTS}${MBD_TMP_SEP}${!host}"
	MBD_TMP_SEP=", "
	if [ -z "${mbd_bldhost}" -a "${!host}" = "$(hostname -f)" ]; then
		# On-the fly default
		db_set mini-buildd-bld/mbd_bldhost "${!host}"
	fi
done
db_subst mini-buildd-bld/mbd_bldhost BLDHOSTS "${BLDHOSTS}"
db_input high mini-buildd-bld/mbd_bldhost || true

# LVM stuff
db_input high mini-buildd-bld/mbd_lvm_vg || true

db_go || true
