#!/bin/sh -e

# Generate sources.lists on "setup-start" for "mini-buildd" chroots.

if [ "${1}" = "setup-start" ] && echo "${CHROOT_DESCRIPTION}" | grep --ignore-case --quiet "mini-buildd"; then
	# Bootstrap mbd lib and value support
	. /usr/lib/mini-buildd/mbd-common.sh
	. /home/mini-buildd/.mini-buildd.conf

	# CHROOT_NAME=mbd-etch-manwe-i386-source
	# CHROOT_NAME=mbd-etch-manwe-i386-83740be5-2da5-41c8-980d-d9c89064607d
	# CHROOT_NAME=mbd-etch-manwe-i386-experimental-source
	# CHROOT_NAME=mbd-etch-manwe-i386-experimental-eeac4e27-4d24-40c3-ad03-671d071c52cb

	BASEDIST=`echo "${CHROOT_NAME}" | cut -d- -f2`
	ARCH=`echo "${CHROOT_NAME}" | cut -d- -f4`

	# Sources list file to generate in chroot
	SOURCES_LIST="${CHROOT_PATH}/etc/apt/sources.list"

	if [ "${CHROOT_TYPE}" = "lvm-snapshot" -a "${AUTH_USER}" = "mini-buildd" ]; then
		# sbuild run using snapshot
		EXPERIMENTAL=`echo "${CHROOT_NAME}" | cut -d- -f5`
		if [ "${EXPERIMENTAL}" != "experimental" ]; then
			EXPERIMENTAL=""
		fi
		mbdGenSources "${BASEDIST}" "base mbd extra ${EXPERIMENTAL}" "${ARCH}" >"${SOURCES_LIST}"
	else
		# Other cases (usually likely -source): Only base.
		mbdGenSources "${BASEDIST}" "base" "${ARCH}" >"${SOURCES_LIST}"
	fi
fi
