#!/bin/sh -e

. `dirname $0`/mbd-common.sh
. "${MBD_BLDCONFIGFILE}"

# Update config file; this must be first
if [ ! -e "/etc/init.d/mini-buildd-rep" ]; then
	# -bld w/o -rep only; retrieve config from rephost.
	mbdGetUrl "${MBD_REPCONFIGFILE}" "http://${mbd_rephttphost}/~mini-buildd/config" || true
fi

mbd_opt_init "Mini-buildd: Builder update script."
mbd_opt_parse "$@"
mbdCheckUser mini-buildd

cd "${MBD_HOME}"
. "${MBD_REPCONFIGFILE}"

mkdir -p "bld/builds"
mkdir -p "bld/chroots"

cat <<EOF >"${MBD_SBUILDCONFIGFILE}"
\$sbuild_mode = "user";
\$log_dir = "/tmp";
\$mailfrom = "${MBD_AUTOBUILD_MAINTAINER} on `hostname -f` <${mbd_mail}>";
\$mailto = "${mbd_mail}";
\$maintainer_name='${MBD_AUTOBUILD_MAINTAINER}';
EOF
${MBD_LOG} -s "${MBD_SBUILDCONFIGFILE} updated."

${MBD_LIB}/mbd-update-common

# Make some items accessible via http
${MBD_LOG} -s "`ln -s -f -v ../bld public_html/ 2>&1`"

mbdUpdateSshKeyring "${mbd_rephost}"

# Check/prepare chroots for all dists.
for dist in `echo "${mbd_dists}" | tr -d ","`; do
	for arch in `echo "${mbd_archs}" | tr -d ","`; do
		# Are we responsible for that arch?
		MBD_TMP_BLDHOST="mbd_bldhost_${arch}"
		if [ "${mbd_bldhost}" = "${!MBD_TMP_BLDHOST}" ]; then
			MBD_TMP_CHROOT="mbd-${dist}-${mbd_id}-${arch}"
			MBD_TMP_LOGFILE="${MBD_HOME}/log/${MBD_TMP_CHROOT}-update.log"

			${MBD_LOG} -s "Updating chroot ${MBD_TMP_CHROOT} (logging to ${MBD_TMP_LOGFILE})..."
			echo "$0 on `date`:" >>"${MBD_TMP_LOGFILE}"
			if ! cat <<EOF | schroot -c "${MBD_TMP_CHROOT}-source" -u root >>"${MBD_TMP_LOGFILE}" 2>&1 ; then
set -e
apt-get update
apt-get --yes --ignore-missing dist-upgrade
[ -z "${MBD_CHROOT_EXTRA_PACKAGES}" ] || apt-get --yes install ${MBD_CHROOT_EXTRA_PACKAGES}
apt-get clean

# Workaround for Debian Bug #327477 (bash building)
[ -e /dev/fd ] || ln -sv /proc/self/fd /dev/fd
[ -e /dev/stdin ] || ln -sv fd/0 /dev/stdin
[ -e /dev/stdout ] || ln -sv fd/1 /dev/stdout
[ -e /dev/stderr ] || ln -sv fd/2 /dev/stderr
EOF
				${MBD_LOG} -s "*ERROR* updating chroot ${MBD_TMP_CHROOT} (see ${MBD_TMP_LOGFILE})."
			fi
		fi
	done
done

exit 0
