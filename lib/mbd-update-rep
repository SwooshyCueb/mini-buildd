#!/bin/sh -e

. $(dirname $0)/mbd-common.sh
mbd_opt_init "Mini-buildd: Repository update script."
mbd_opt_add "p" "Special handling for debian postinstall run."
mbd_opt_parse "$@"
mbdCheckUser mini-buildd

cd "${MBD_HOME}"
. "${MBD_REPCONFIGFILE}"

mkdir -p "rep" "log" ".mini-buildd/apt-secure" ".mini-buildd/chroots-update.d"

# Add README for .mini-buildd/
cat <<EOF >.mini-buildd/README
Automatically produced by $(basename $0) on $(date).
Manual changes to this file are NOT preserved.

README for "~/.mini-buildd/": Place for local configuration

DO CHANGES ON THE REPOSITORY HOST ONLY. On builder-only hosts,
this directory is SYNCED from the repository host.

You may do the following customizations:

 * "apt-secure/": Add extra keys named "*.key" (used by 05_apt-secure).
 * "chroots-update.d/": Add scripts to run via run-parts (run from 99_local).
EOF

MBD_TMP_DISTS=$(mbdD2SList "${mbd_dists}")
cat <<EOF >"${MBD_MDINSTALLCONFIGFILE}"
[DEFAULT]
archivedir = ${MBD_HOME}/rep
mail_to = ${mbd_mail}

trigger_reindex = 1
mail_on_success = 0
# @todo Default is on when debian-keyring package is installed; we don't want this enabled ever (yet)
verify_sigs = 0

incoming_permissions = 0755

pre_install_script = ${MBD_LIB}/mbd-preinstall
#post_install_script = ${MBD_LIB}/postinstall
release_signscript = ${MBD_LIB}/mbd-sign-release

architectures = all, ${mbd_archs}
archive_style = flat
generate_release = 1
chown_changes_files = 0
experimental_release = 1
release_origin = Mini-Buildd for ${mbd_id} on ${mbd_rephost}

$(for d in ${MBD_TMP_DISTS}; do
   echo "[${d}-${mbd_id}]";
   echo "release_description = ${d} packages for ${mbd_id}.";
   echo "release_label = ${d}-${mbd_id}";
   echo "keep_old = 1";
   echo;
   echo "[${d}-${mbd_id}-experimental]";
   echo "release_description = EXPERIMENTAL ${d} packages for ${mbd_id}.";
   echo "release_label = ${d}-${mbd_id}-experimental";
   echo "keep_old = 0";
   echo;
 done)
EOF
${MBD_LOG} -s "${MBD_MDINSTALLCONFIGFILE} updated."

${MBD_LIB}/mbd-update-common
${MBD_LIB}/mbd-update-rep-html

# Run mbd-update-bld on all build hosts
for host in $(mbdGetBldHosts); do
	mbdUpdateSshKeyring "${host}"
	${MBD_LOG} -s "Updating build hosts ${host}..."
	if ! ssh -o StrictHostKeyChecking="no" -p "${mbd_sshport}" "${host}" "${MBD_LIB}/mbd-update-bld"; then
		${MBD_LOG} -s "Warning: Error updating build host ${host} (ignore if not set up yet)"
	fi
done

if ! mbd_opt_given p; then
	${MBD_LOG} -s "$(/etc/init.d/mini-buildd-rep restart 2>&1)"
fi

exit 0
