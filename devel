#!/bin/bash -e

# Change env MIRROR for the default config before calling this
[ -n "${MIRROR}" ] || MIRROR="http://localhost/~mirror/debian/debian"

# Test home is in '..' to avoid problems with large files in the Debian Source Tree
MBD_HOME="/tmp/mini-buildd-devel"
MBD_CMD="./mini-buildd --home="${MBD_HOME}" --instdir="$(pwd)" --foreground --verbose"

_head()
{
	printf "\n=> ${*}\n"
}

mbd_clear()
{
	_head "Cleaning incoming, spool and repository in ${MBD_HOME}"
	rm -rf ${MBD_HOME}/spool/* ${MBD_HOME}/incoming/* ${MBD_HOME}/repositories/*
}

mbd_purge()
{
	_head "Purging ${MBD_HOME}"
	[ ! -e "${MBD_HOME}" ] || rm -r "${MBD_HOME}"
	mkdir -v -p "${MBD_HOME}"
}

mbd_default()
{
	mbd_purge

	_head "Creating superuser admin/admin..."
	${MBD_CMD} --set-admin-password="admin"

	_head "Creating default config..."
	${MBD_CMD} --create-default-config="${MIRROR}"
}

for c in $(compgen -A function | grep '^mbd_'); do
	ACTIONS+="${c:4}|"
done
trap "printf '\nUsage: ${0} ${ACTIONS}\n' >&2" ERR

# Be sure to generate mini_buildd/__version__.py
python ./setup.py >/dev/null 2>&1 || true

if [ -n "${1}" ]; then
	mbd_${1}
	shift
fi

_head "Running: ${MBD_CMD} ${@}"
${MBD_CMD} ${@}
