#!/bin/bash -e

# Change env MIRROR for the default config before calling this
[ -n "${MIRROR}" ] || MIRROR="http://localhost/~mirror/debian/debian"

# Test home is in '..' to avoid problems with large files in the Debian Source Tree
MBD_HOME="$(readlink -f $(dirname "${0}"))/../mini-buildd-devel-home"
MBD_CMD="./mini-buildd --home="${MBD_HOME}" --instdir="$(pwd)" --foreground --verbose --verbose"

_head()
{
	printf "\n=> ${*}\n"
}

mbd_reset()
{
	_head "Purging ${MBD_HOME}"
	[ ! -e "${MBD_HOME}" ] || rm -r "${MBD_HOME}"
	mkdir -v -p "${MBD_HOME}"
}

mbd_default()
{
	mbd_reset

	_head "Creating superuser admin/admin..."
	${MBD_CMD} --set-admin-password="admin"

	_head "Creating default config..."
	${MBD_CMD} --create-default-config="${MIRROR}"
}

trap "printf '\nUsage: ${0} [reset|default]\n' >&2" ERR

# Be sure to generate mini_buildd/__version__.py
python ./setup.py >/dev/null 2>&1 || true

[ -z "${1}" ] || mbd_${1}

_head "Running: ${MBD_CMD}"
${MBD_CMD}
