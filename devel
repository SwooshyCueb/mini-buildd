#!/bin/bash -e

# Change env MIRROR for the default config before calling this
[ -n "${MIRROR}" ] || MIRROR="http://localhost/~mirror/debian/debian"

MBD_HOME="$(readlink -f $(dirname "${0}"))/devel-home"
MBD_CMD="./mini-buildd --home="${MBD_HOME}" --instdir="$(pwd)" --foreground --verbose --verbose --no-act"

printf "MBD-Command: ${MBD_CMD}\n"

_head()
{
	printf "\n=> ${*}\n"
}

# Be sure to generate mini_buildd/__version__.py
python ./setup.py >/dev/null 2>&1 || true

case "${1}" in
	reset):
		_head "Purging ${MBD_HOME}"
		[ ! -e "${MBD_HOME}" ] || rm -r "${MBD_HOME}"
		mkdir -v -p "${MBD_HOME}"
		;;

	default)
		${0} reset

		_head "Create superuser admin/admin..."
		${MBD_CMD} --set-admin-password="admin"

		_head "Create default config..."
		${MBD_CMD} --create-default-config="${MIRROR}"

		shift
		${0} run ${@}
		;;

	run)
		_head "Running ${MBD_CMD} $@"

		shift
		${MBD_CMD} "$@"
		;;
	*)
		printf "Usage: $0 reset|run\n" >&2
		exit 2
		;;
esac
