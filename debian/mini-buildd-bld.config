#!/bin/bash -e

# @hack: Must be the same as in mbd-common.sh (we cannot include that so that pre-configuration is possible).
MBD_BLDCONFIGFILE="/home/mini-buildd/.mini-buildd-bld.conf"
MBD_BLDCONFIGVARS="mbd_defer mbd_rephttphost mbd_bldhost mbd_lvm_vg"

. /usr/share/debconf/confmodule

# Load config file, if it exists.
if [ -e "${MBD_BLDCONFIGFILE}" ]; then
	. "${MBD_BLDCONFIGFILE}" || true

	# Store values from config back to debconf
	for v in ${MBD_BLDCONFIGVARS}; do
		db_set mini-buildd-bld/${v} "${!v}"
	done
else
	# On-The-Fly defaults
	db_set mini-buildd-bld/mbd_defer false
	db_set mini-buildd-bld/mbd_rephttphost "$(hostname -f)"
fi

# First, get the repository's host name, and suck our configuration
REPO_PRIO=high
REPO_CONFIGFILE=""
checkRepo()
{
	if [ -z "${REPO_CONFIGFILE}" ]; then
		REPO_CONFIGFILE=$(mktemp -t)
		trap "rm -f ${REPO_CONFIGFILE}" EXIT
	fi

	db_get mini-buildd-bld/mbd_rephttphost || true
	local repo="${RET}"
	local config_url="http://${repo}/~mini-buildd/config"
	if wget --quiet --output-document=- "${config_url}" >"${REPO_CONFIGFILE}"; then
		# Repo valid
		db_subst mini-buildd-bld/mbd_defer STATUS "Repo host \"${repo}\": Config found."
		return 0
	else
		# Current value is invalid: Make sure next time user sees it again.
		db_fset mini-buildd-bld/mbd_defer seen false
		db_fset mini-buildd-bld/mbd_rephttphost seen false
		REPO_PRIO=critical
		db_subst mini-buildd-bld/mbd_defer STATUS "Repo host \"${repo}\": NOT SET UP."
		return 1
	fi
}

while true; do
	checkRepo || true
	db_input ${REPO_PRIO} mini-buildd-bld/mbd_defer || true
	db_go || true
	db_get mini-buildd-bld/mbd_defer || true
	if ${RET}; then
		# Defer; exit script here
		exit 0
	else
		db_input ${REPO_PRIO} mini-buildd-bld/mbd_rephttphost || true
		db_go || true
		if checkRepo; then
			break;
		fi
	fi
done

# At this point, the repo must be valid; go and configure the
# rest using downloaded repo configuration.
. "${REPO_CONFIGFILE}"

# Get "mbd_bldhost"; the hideously exaggerated code is just to
# show the user a convenient choices list of all possible build
# hosts ;).
BLDHOSTS=""
MBD_TMP_SEP=""
for arch in $(echo "${mbd_archs}" | tr -d ","); do
	host="mbd_bldhost_${arch}"
	BLDHOSTS="${BLDHOSTS}${MBD_TMP_SEP}${!host}"
	MBD_TMP_SEP=", "
	if [ -z "${mbd_bldhost}" -a "${!host}" = "$(hostname -f)" ]; then
		# On-the fly default
		db_set mini-buildd-bld/mbd_bldhost "${!host}"
	fi
done
db_subst mini-buildd-bld/mbd_bldhost BLDHOSTS "${BLDHOSTS}"
db_input high mini-buildd-bld/mbd_bldhost || true

# LVM stuff
db_input high mini-buildd-bld/mbd_lvm_vg || true

db_go || true
