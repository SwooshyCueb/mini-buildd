#!/bin/sh -e

# Manage sources.lists on "setup-start", for user "mini-buildd".

log_info()
{
	if [ "${AUTH_VERBOSITY}" != "quiet" ]; then
		echo "I: [mini-buildd]: ${1}" >&2
	fi
}

add_sources()
{
	for l in ${2}; do
		# @todo: find out arch from chroot name
		for a in any; do
			local f="${1}/${l}.${a}.list"
			if [ -f "${f}" ]; then
				echo "# ${l}-${a}" >>"${3}"
				cat "${f}" >>"${3}"
				echo "" >>"${3}"
				log_info "Sources list added: ${f}."
			fi
		done
	done
}

# We only act on chroots having "mini-buildd" in description
if echo "${CHROOT_DESCRIPTION}" | grep --ignore-case --quiet "mini-buildd"; then
	if [ "${1}" = "setup-start" ]; then
		DIST=`basename "${CHROOT_DEVICE}"`

		# Sources list file to generate in chroot
		SOURCES_LIST="${CHROOT_PATH}/etc/apt/sources.list"
		echo -e "# Auto-generated on `date` by ${0}.\n" >"${SOURCES_LIST}"
		SOURCES_DIR="/home/mini-buildd/bld/chroots/${DIST}"

		# Base is for both, source and snasphots
		add_sources "${SOURCES_DIR}" "base" "${SOURCES_LIST}"

		# Add extra sources for snapshots driven by mini-buildd only
		if [ "${CHROOT_TYPE}" = "lvm-snapshot" -a "${AUTH_USER}" = "mini-buildd" ]; then
			add_sources "${SOURCES_DIR}" "mbd extra" "${SOURCES_LIST}"
		fi

		# Update apt cache in chroot
		log_info "Updating apt cache for ${DIST}."
		chroot "${CHROOT_PATH}" apt-get update >/dev/null 2>&1
	fi
fi
