#!/bin/sh -e

. `dirname $0`/mbd-common.sh

mbd_opt_init "Mini-buildd: Remove a package from the repository."
mbd_opt_add "p:" "Package pattern (see find); for example PACKAGE_VERSION."
mbd_opt_add "Y:" "Don't ask before removing."
mbd_opt_parse "$@"

echo "WARNING: This is EXPERIMENTAL. Use only for testing." >&2
echo >&2

PACKAGE=`mbd_opt_get p`

/etc/init.d/mini-buildd-rep stop

# Iterate over all changes files
for c in `find ${MBD_HOME}/rep/ -type f -name "${PACKAGE}*.changes"`; do
	dir=`dirname ${c}`
	mbdParseCF "${c}"
	log="${MBD_HOME}/log/${mbdParseCF_package}/${mbdParseCF_version}"

	echo
	echo "Changes: ${c}"
	echo "Files  : ${mbdParseCF_files}"
	echo
	answer="n"
	read -p"Remove this package (y/N)? " answer

	if [ "${answer}" = "y" ]; then
		for f in ${mbdParseCF_files}; do
			echo "Would remove: ${dir}/${f}"
		done
		echo "Would remove: ${dir}.db"
		echo "Would remove: ${log}"
	fi
done

/etc/init.d/mini-buildd-rep restart
